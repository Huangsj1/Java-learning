# 一、执行流程

1. **连接**：
	1. 连接MySQL服务是通过TCP连接进行的，需要经过三次握手
	2. 连接建立后还需要检验用户名和密码是否正确，正确后才能进行后续操作
2. **查询缓存**：对SQL语句通过 key-value 方式进行查询缓存，但是缓存很难命中，所以MySQL8之后移除
3. **解析SQL**：词法分析、语法分析，得到语法树
4. **执行SQL**：
	1. 预处理：查询表/字段是否存在、解析 `*` 为所有列名
	2. 优化器：优化SQL语句，包括调整 `where`、选择索引
	3. 执行器：从存储引擎读取数据返回给客户端，包括主键索引查询、全表扫描、索引下推
		* `Server` 层**每次会从存储引擎读取一条记录并返回给客户端**，然后继续从存储引擎中读取

![[Pasted image 20240321104821.png]]

# 二、数据的存储

## 1. 磁盘文件

每个数据库有对应的文件夹，里面包含：

1. `db.opt`：当前数据库的默认字符集和字符校验规则
2. `***.frm`：表结构定义
3. `***.idb`：表数据

### 表空间结构

* 行：数据库表中**每条数据按行存放**
* 页：数据库**按页从磁盘读取**，默认16KB每页，里面可包含多个多行
* 区：在B+树中双向链表进行范围查询的时候，为了能让相邻数据在磁盘中存储位置也相邻，将**多个相邻页组成一个区来进行磁盘存储**，每个区1MB
	* 磁盘中相邻页读取更加快速
* 段：**表空间结构分为多个段**：
	* 索引段：B+树非叶子节点的区集合
	* 数据端：B+树叶子结点的区集合
	* 回滚段：回滚数据的区集合

![[Pasted image 20240321113331.png]]

## 2. 行的格式

MySQL5.0之后采用的是 `Compact` 压缩格式，5.7之后采用 `Dynamic` 格式，`Dynamic`和`Compressed`与 `Compact` 类似（下面介绍 `Compact`）

![[Pasted image 20240321114045.png]]

### 1. 额外信息

1. **变长字段长度列表**：对于一些边长数据类型需要**存储当前实际长度**（字节数），**按列逆序存储**
	* 没有边长类型的列就可以删去该字段
2. **NULL值列表**：通过位图方式记录了**所有没设置 `not null` 的列是否为null值**，**按列逆序存储**，按照字节（8位）单位进行补齐
	* 所有列都是 `not null` 就可以删除该字段
3. 记录头信息：
	1. 当前行是否被删除
	2. 下一条记录位置：”记录头信息“的结束位置，所以**向右读取就是真实数据，向左读取就是NULL值、变长字段长度**，所以变长字段列表和NULL值列表需要按列逆序存储
	3. 当前记录类型，包括B+树非叶子节点、最小记录、最大记录

### 2. 真实数据

隐藏字段：

1. `row_id`：建表时没有指定主键/唯一约束就会创建该字段
2. `trx_id`：事务id，表示当前数据由哪个事务创建
3. `roll_ptr`：记录上一个版本的指针

### 3. 行的大小

除了 `TEXT, BLOGs` 等大型对象之外，**其他所有列（不包括隐藏字段和记录头信息）占用的字节长度加起来不能超过65535字节**（16KB一页）

#### varchar(n) 中n最大值

当整行只有一个 `varchar(n)` 类型的字段的时候：

* **变长字段长度列表 + NULL值列表 + 数据长度 <= 65535字节**
	* 数据不超过65535字节，所以变长字段为2字节（不超过255字节时变长字段为1字节）
	* NULL值列表根据数据的可为NULL值的列来确定长度，如果这里设置了该列不为NULL，则无NULL值字段
	* 所以最终数据长度最大为 65535 - 2 = 65533字节

### 4. 行溢出

移除后会将最后20字节指向溢出页的地址：

![[Pasted image 20240321144538.png]]

`Compressed, Dynamic` 的溢出方式和 `Compact` 不同，不会存储部分数据，而是直接存储溢出页地址：

![[Pasted image 20240321144626.png]]
