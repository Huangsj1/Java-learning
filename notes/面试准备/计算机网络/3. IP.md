# 一、报文结构

## 1. IP 报文

![[Pasted image 20240319101818.png]]

* **源ip地址和目的ip地址**，各自4字节
* **TTL**：生存时间

## 2. MAC帧

![[Pasted image 20240319101221.png]]

* 目的地址和源地址是**MAC地址**，各自6字节

# 杂项

## 1. MAC地址和IP地址

* 为什么有了MAC地址还需要有IP地址：
	1. **只有MAC地址的话只能在同一个网络中进行数据传输，ip地址可以跨网络传输**
	2. MAC地址唯一标识一个设备，相当于一个人的身份证；而IP地址是动态获取的、可变的，相当于人的居住地址。当传输数据的时候如果只指定MAC地址很难找到对应的设备，而**使用了ip地址后可以根据子网来让路由器决定往哪里转发**，就像有了地址之后可以根据省份、市来有方向的传输
* 为什么有了IP地址还需要MAC地址：
	1. 一个IP地址可能对应多个设备，MAC才是最终表示设备的地址，通过IP找到门牌号后，由MAC决定给谁

## 2. DHCP

* DHCP用的是UDP来进行广播
	* 路由器可以作为中继代理来将广播转成单播传到下一个路由器/DHCP服务器

## 3. NAT

NAT网络地址转换可以将私有地址+端口转换成**公有地址+端口**（NAPT转换表），这样只需要一个公网地址即可

缺点：

1. **外部无法主动和NAT内部服务器建立连接**，因为NAT建立映射关系是通过内部服务器发送请求后NAT才建立的
2. 转换表的生成和转换操作都有**性能开销**

解决：

1. 通过**ipv6**每台设备就可以直接用公网地址
2. NAT穿透技术：网络应用程序主动发现位于NAT中，并**主动在在NAT中建立映射**

## 4. ICMP

ICMP互联网控制报文协议包括两种：

1. 查询报文：发送给目标让目标回应，包括回送请求、回送应答
	* `ping`：判断主机是否能连通目的地址，用的就是**回送请求报文**，在ip报文中也记录了TTL
2. 差错请求报文：路由器无法将数据包发送给目标的时候会向发送端主机发送差错请求报文，告知主机不可达原因
	* `traceroute`：追踪去往目的主机经过的所有路由器，通过**从1开始TTL递增的UDP包**来接收**ICMP超时消息**，到达目的主机时会返回一个端口不可达的ICMP消息

### 断网了ping 127.0.0.1

断网了表示网卡不可用，无法将数据包通过网卡发送出去

* `127.0.0.1`：本地回环地址，选择”本地网卡“转发，也就是**直接将其加入到内核的 `input_pkt_queue` 队列中**，然后**通过软中断让内核从链表中取出数据处理**，不会通过网卡发送，所以**可以ping通**
* `本地主机ip地址`：ping本地主机ip和ping 127.0.0.1一样，都是走本地回环地址，所以**可以ping通**
* `localhost`：相当于域名，在操作系统内**会解析成 127.0.0.1**
* `0.0.0.0`：无法 ping 0.0.0.0，因为该地址无效，**服务器可以监听这个地址来监听所有本机的ip地址**
* `外网ip地址`：将数据包加入到 `Ring` 中给真网卡读取发送，所以**不能ping通**

![[Pasted image 20240321103044.png|500]]